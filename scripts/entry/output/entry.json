{"AWSTemplateFormatVersion": "2010-09-09", "Parameters": {"ProjectName": {"Type": "String"}, "QSS3BucketName": {"Type": "String", "Default": "aws_quickstart"}, "QSS3KeyPrefix": {"Type": "String", "Default": "quickstart-ammos-smallsat-toolkit/"}, "QSS3BucketRegion": {"Type": "String", "Default": ""}, "MainStackParams": {"Type": "String"}, "RolePath": {"Type": "String", "Default": ""}, "PermissionsBoundaryArn": {"Type": "String", "Default": ""}}, "Conditions": {"RolePathProvided": {"Fn::Not": [{"Fn::Equals": ["", {"Ref": "RolePath"}]}]}, "UsingDefaultBucket": {"Fn::Equals": [{"Ref": "QSS3BucketName"}, "aws-quickstart"]}, "PermissionsBoundaryProvided": {"Fn::Not": [{"Fn::Equals": ["", {"Ref": "PermissionsBoundaryArn"}]}]}}, "Resources": {"ConfigParserRole": {"Type": "AWS::IAM::Role", "Properties": {"RoleName": {"Fn::Sub": "${ProjectName}-ConfigParser"}, "AssumeRolePolicyDocument": {"Statement": [{"Action": "sts:AssumeRole", "Effect": "Allow", "Principal": {"Service": "lambda.amazonaws.com"}}], "Version": "2012-10-17"}, "ManagedPolicyArns": [{"Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"}], "Path": {"Fn::If": ["RolePathProvided", {"Ref": "RolePath"}, {"Ref": "AWS::NoValue"}]}, "PermissionsBoundary": {"Fn::If": ["PermissionsBoundaryProvided", {"Ref": "PermissionsBoundaryArn"}, {"Ref": "AWS::NoValue"}]}, "Policies": [{"PolicyDocument": {"Statement": [{"Action": "iam:GetRole", "Effect": "Allow", "Resource": {"Fn::Join": ["", [{"Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role"}, {"Fn::If": ["RolePathProvided", {"Ref": "RolePath"}, "/"]}, {"Fn::Sub": "${ProjectName}"}, "-*"]]}}], "Version": "2012-10-17"}, "PolicyName": "ConfigParser-Policy"}]}}, "ConfigParser": {"Type": "AWS::Lambda::Function", "Properties": {"FunctionName": {"Fn::Sub": "${ProjectName}-ConfigParser"}, "Handler": "config_parser.handler", "MemorySize": 256, "Timeout": 300, "Role": {"Fn::GetAtt": ["ConfigParserRole", "Arn"]}, "Runtime": "python3.9", "Code": {"S3Bucket": {"Fn::If": ["UsingDefaultBucket", {"Fn::Sub": "${QSS3BucketName}-${AWS::Region}"}, {"Ref": "QSS3BucketName"}]}, "S3Key": {"Fn::Sub": "${QSS3KeyPrefix}functions/packages/ConfigParser/lambda.zip"}}}}, "Config": {"Type": "AWS::CloudFormation::CustomResource", "Properties": {"ServiceToken": {"Fn::GetAtt": ["ConfigParser", "Arn"]}, "MainStackParams": {"Ref": "MainStackParams"}}}, "MainStack": {"Type": "AWS::CloudFormation::Stack", "Properties": {"TemplateURL": {"Fn::Sub": ["https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/main.yaml", {"S3Region": {"Fn::If": ["UsingDefaultBucket", {"Ref": "AWS::Region"}, {"Ref": "QSS3BucketRegion"}]}, "S3Bucket": {"Fn::If": ["UsingDefaultBucket", {"Fn::Sub": "${QSS3BucketName}-${AWS::Region}"}, {"Ref": "QSS3BucketName"}]}}]}, "Parameters": {"ProjectName": {"Fn::GetAtt": ["Config", "ProjectName"]}, "QSS3KeyPrefix": {"Fn::GetAtt": ["Config", "QSS3KeyPrefix"]}, "QSS3BucketName": {"Fn::GetAtt": ["Config", "QSS3BucketName"]}, "One": {"Fn::GetAtt": ["Config", "One"]}, "Two": {"Fn::GetAtt": ["Config", "Two"]}, "Three": {"Fn::GetAtt": ["Config", "Three"]}, "Four": {"Fn::GetAtt": ["Config", "Four"]}}}}}}